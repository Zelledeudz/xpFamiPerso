<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ressources Dofus - Calculateur XP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .download-csv {
            background-color: #27ae60;
        }
        .download-csv:hover {
            background-color: #229954;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #e8f4fd;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .price-input {
            width: 80px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .xp-per-kama, .quantity-1-80 {
            font-weight: bold;
            color: #27ae60;
        }
        .info {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Calculateur XP Ressources Dofus</h1>

        <div class="info">
            <strong>Instructions :</strong>
            <ul>
                <li>Remplissez la colonne "Prix" avec les prix actuels des ressources</li>
                <li>Les colonnes "XP par Kama" et "Quantit√© pour 1-80" se calculent automatiquement</li>
                <li>Le calcul pour 1-80 utilise la valeur 80678 XP comme demand√©</li>
                <li>Vous pouvez t√©l√©charger le tableau en CSV ou Excel</li>
                <li>Les prix sont synchronis√©s en temps r√©el entre tous les utilisateurs</li>
            </ul>
        </div>
        <div class="controls">
            <button onclick="downloadCSV()" class="download-csv">üì• T√©l√©charger CSV</button>
            <button onclick="downloadExcel()">üìä T√©l√©charger Excel</button>
            <button onclick="clearPrices()">üóëÔ∏è Effacer tous les prix</button>
        </div>
        <div class="table-container">
            <table id="resourcesTable">
                <thead>
                    <tr>
                        <th>Nom de la ressource</th>
                        <th>Quantit√© d'exp√©rience</th>
                        <th>Prix (Kamas)</th>
                        <th>XP par Kama</th>
                        <th>Quantit√© pour 1-80</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDTMFB4EqJdjryu582PtbVy2AD4RJsJre8",
            authDomain: "dofus-calculator.firebaseapp.com",
            projectId: "dofus-calculator",
            storageBucket: "dofus-calculator.appspot.com",
            messagingSenderId: "38115522441",
            appId: "1:38115522441:web:cf71ca8b198e352bce8156",
            measurementId: "G-BS8GJQ0MR6",
            databaseURL: "https://dofus-calculator-default-rtdb.europe-west1.firebasedatabase.app/"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Donn√©es extraites du fichier CSV
        const resourcesData = [
            ["Galet brasillant", 1250, 1],
            ["Galet acajou", 1250, 1],
            ["Rune Ga Pa", 500, 1],
            ["Rune Ga Pme", 405, 1],
            ["Coeur Gel√©", 375, 1],
            ["Alliage Ivre", 375, 1],
            ["Braguette de Nileza", 338, 1],
            ["Culotte de Missiz Frizz", 338, 1],
            ["Incisive de Sylargh", 338, 1],
            ["Scalp de Klime", 338, 1],
            ["Bandelette du Comte Harebourg", 338, 1],
            ["Coeur de Merkator", 338, 1],
            ["Poche de magma de Grasmera", 338, 1],
            ["Galet Solaire", 313, 1],
            ["Cuir Onique", 300, 1],
            ["Encre du Kralamoure g√©ant", 281, 1],
            ["Hamatum de Glours√©leste", 254, 1],
            ["Condyle de Fuji Givrefoux", 254, 1],
            ["√âtoffe de Kolosso", 254, 1],
            ["√âtoffe givr√©e", 254, 1],
            ["Eclat temporel", 254, 1],
            ["Fermeture √©clair", 200, 1],
            ["Mycoses gel√©es", 200, 1],
            ["Oeil de verre", 200, 1],
            ["Racine cristalline", 200, 1],
            ["Boulon neuf", 200, 1],
            ["Oeil de Korriandre", 196, 1],
            ["Fragment d'Ougalurette", 195, 1],
            ["Peau du Bworker", 195, 1],
            ["Vert√®bre d'Obsidiantre", 161, 1],
            ["Cuir de Tengu Givrefoux", 153, 1]
        ];

        // Cr√©er le tableau
        function createTable() {
            const tableBody = document.getElementById('tableBody');

            resourcesData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td><input type="number" class="price-input" onchange="calculateRow(${index})" placeholder="Prix..." step="0.01"></td>
                    <td class="xp-per-kama" id="xp-${index}">-</td>
                    <td class="quantity-1-80" id="qty-${index}">-</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // Calculer une ligne
        function calculateRow(index) {
            const priceInput = document.querySelector(`#tableBody tr:nth-child(${index + 1}) .price-input`);
            const xpCell = document.getElementById(`xp-${index}`);
            const qtyCell = document.getElementById(`qty-${index}`);

            const price = parseFloat(priceInput.value);
            const xp = resourcesData[index][1];

            if (price && price > 0) {
                const xpPerKama = xp / price;
                const quantityFor180 = 80678 / xp;

                xpCell.textContent = xpPerKama.toFixed(4);
                qtyCell.textContent = Math.ceil(quantityFor180).toLocaleString();

                // Sauvegarder dans Firebase
                const priceRef = firebase.database().ref('prices/' + index);
                priceRef.set(price);
            } else {
                xpCell.textContent = '-';
                qtyCell.textContent = '-';

                // Supprimer de Firebase
                const priceRef = firebase.database().ref('prices/' + index);
                priceRef.remove();
            }
        }

        // √âcouter les changements de prix en temps r√©el
        function listenToChanges() {
            const pricesRef = firebase.database().ref('prices');
            pricesRef.on('value', (snapshot) => {
                const prices = snapshot.val();
                if (prices) {
                    Object.keys(prices).forEach(index => {
                        const priceInput = document.querySelector(`#tableBody tr:nth-child(${parseInt(index) + 1}) .price-input`);
                        const xpCell = document.getElementById(`xp-${index}`);
                        const qtyCell = document.getElementById(`qty-${index}`);

                        if (priceInput && priceInput.value != prices[index]) {
                            priceInput.value = prices[index];

                            const price = parseFloat(prices[index]);
                            const xp = resourcesData[index][1];
                            const xpPerKama = xp / price;
                            const quantityFor180 = 80678 / xp;

                            xpCell.textContent = xpPerKama.toFixed(4);
                            qtyCell.textContent = Math.ceil(quantityFor180).toLocaleString();
                        }
                    });
                }
            });
        }

        // Effacer tous les prix
        function clearPrices() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer tous les prix ?')) {
                // Effacer dans Firebase
                const pricesRef = firebase.database().ref('prices');
                pricesRef.remove();

                const inputs = document.querySelectorAll('.price-input');
                inputs.forEach(input => {
                    input.value = '';
                });

                // Effacer les calculs
                resourcesData.forEach((_, index) => {
                    document.getElementById(`xp-${index}`).textContent = '-';
                    document.getElementById(`qty-${index}`).textContent = '-';
                });
            }
        }

        // T√©l√©charger en CSV
        function downloadCSV() {
            let csvContent = "Nom de la ressource,Quantit√© d'exp√©rience,Prix,XP par Kama,Quantit√© pour 1-80\n";

            resourcesData.forEach((row, index) => {
                const priceInput = document.querySelector(`#tableBody tr:nth-child(${index + 1}) .price-input`);
                const xpCell = document.getElementById(`xp-${index}`);
                const qtyCell = document.getElementById(`qty-${index}`);

                const price = priceInput.value || '';
                const xpPerKama = xpCell.textContent === '-' ? '' : xpCell.textContent;
                const quantity = qtyCell.textContent === '-' ? '' : qtyCell.textContent.replace(/,/g, '');

                csvContent += `"${row[0]}",${row[1]},${price},${xpPerKama},${quantity}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'ressources_dofus_xp.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // T√©l√©charger en Excel
        function downloadExcel() {
            const data = [
                ["Nom de la ressource", "Quantit√© d'exp√©rience", "Prix", "XP par Kama", "Quantit√© pour 1-80"]
            ];

            resourcesData.forEach((row, index) => {
                const priceInput = document.querySelector(`#tableBody tr:nth-child(${index + 1}) .price-input`);
                const xpCell = document.getElementById(`xp-${index}`);
                const qtyCell = document.getElementById(`qty-${index}`);

                const price = priceInput.value ? parseFloat(priceInput.value) : '';
                const xpPerKama = xpCell.textContent === '-' ? '' : parseFloat(xpCell.textContent);
                const quantity = qtyCell.textContent === '-' ? '' : parseInt(qtyCell.textContent.replace(/,/g, ''));

                data.push([row[0], row[1], price, xpPerKama, quantity]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ressources Dofus XP");
            XLSX.writeFile(wb, "ressources_dofus_xp.xlsx");
        }

        // Initialiser l'application
        window.onload = function() {
            createTable();
            listenToChanges();
        };
    </script>
</body>
</html>
